<html>
<head>

<LINK href="default.css" rel="stylesheet" type="text/css">
<style>  </style>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="http://cdn.socket.io/stable/socket.io.js"></script> 
<script>
"use strict"
var colA= ['FF0000','00FF00','0000FF', 'FFFF00', '00FFFF', 'FF00FF', 'FF6600', '000000'];
var cW, cH;
var latestCursorPostion;
var selectionA=[];
var selectionStart=false;
var canvas, ctx;
var maxSizeSelection=12;
var updateGolCanvas = function(d, canvas)
{
  var y=d.y;
  var x=d.x;
  timeout = d.t;
  var world = d.w;
  ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  //var r = canvas.height/y;
  //var h = (canvas.height-r)/y;
  var h = (canvas.height)/y; cH=h;
  //var w = (canvas.width-r)/x;
   var w = (canvas.width)/x; cW=w;
  var cell = function(cx,cy,nrid,ctx){
    ctx.fillStyle = "#"+colA[nrid-1];
    ctx.fillRect (cx, cy, w, h);
    ctx.fillStyle = "#FF0000";
 //   ctx.fillStyle = "#FF0000";
    ctx.strokeRect(cx, cy, w, h);
  
  }
  
  if(selectionA)
  {
    drawSelection(selectionA);
  }
  
  for(var i = 0; i<y; i++)
  {
    for(var j = 0; j<x; j++)
    {
      wni=(i*x)+j;
      if(world[wni])
      {
        //cell((j+1)*w,(i+1)*h,world[wni],ctx);
        cell((j)*w,(i)*h,world[wni],ctx);
      }

    }
  }
  
  
}

var drawSelection = function(A)
{
  //ctx=canvas.getContext("2d")
  for(var i = 0; i<A.length;i++)
  { 
    var a = A[i];
    if(selectionStart==true)
    {
      ctx.fillStyle = "#848484";
      ctx.strokeRect((a.x)*cW, (a.y)*cH, cW, cH);
      ctx.fillRect((a.x)*cW, (a.y)*cH, cW, cH);
    //alert('test');
    }
    else
    {
      ctx.fillStyle = "#F2F2F2";
      ctx.strokeRect((a.x)*cW, (a.y)*cH, cW, cH);
    }
  }
  return this;
 
}


$(document).ready(function() {

$('body').append('<canvas id="world" width="'+$(window).width()+'" height="'+$(window).height()+'" style="border:0px solid red;"></canvas>')
canvas = document.getElementById('world');
ctx = canvas.getContext("2d");
var socket = new io.Socket('127.0.0.1', {port:3001, 'transports':['websocket' ]}); 
//var socket = new io.Socket('gameoflife.duostack.net', {port:9980, 'transports':['websocket' ]}); 


socket.on('connect', function(){ 
  //alert('connect');
  socket.send('start'); 
});
socket.on('message', function(data){ 
  //alert('data '+data);
  updateGolCanvas(data, document.getElementById('world'));
});
socket.on('disconnect', function(){
  // alert('disconnect');
}); 
socket.connect();

function getCursorPosition(e, gCanvasElement) {
    /* returns Cell with .row and .column properties */
    var x;
    var y;
    if (e.pageX != undefined && e.pageY != undefined) {
	x = e.pageX;
	y = e.pageY;
    }
    else {
	x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
	y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
    }
    x -= gCanvasElement.offsetLeft;
    y -= gCanvasElement.offsetTop;
    x = Math.min(x, gCanvasElement.width * cW);
    y = Math.min(y, gCanvasElement.height* cH);
    
    var r = {'x':Math.floor(x/cW), 'y':Math.floor(y/cH)}
    //alert('x'+r.x+'y'+r.y);
    return r;
}

$('#world').click(function(e){
 //var a = getCursorPosition(e, this);
 //a.id='a';
 //socket.send(a);
 
 if(selectionStart==false)
 {
  selectionStart=true;
  //alert(selectionStart);
 }
 else
 {
  //send the selection to the server
  socket.send({'type':'selectionA', 'id':'a', 'selectionA':selectionA});
  selectionStart=false;
  selectionA.length=0;
 }
 
  });

var postionInArray = function(a,selA)
{
   for(var j = 0; j<selA.length; j++)
   {
        if(a.x==selA[j].x&&a.y==selA[j].y)
        {
          return j;
        }
   }
   return -1;
}


$('#world').mousemove(function(e){
 latestCursorPostion = getCursorPosition(e, this);
 if(selectionStart==true)
 {
       //if the selection matches an element that is allready in the array
      var pos = postionInArray(latestCursorPostion, selectionA);
       //alert(pos+'!=-1&&'+pos+'!=('+selectionA.length-1+'))');
      // alert(selectionA.length);
  //if(pos!=-1&&pos!=(selectionA.length-1))
  
  if((pos!=-1&&pos!=(selectionA.length-1))||selectionA.length>maxSizeSelection)
  {
 // alert('hi'+pos);
    //alert('hi'+pos);
    //send selection
    socket.send({'type':'selectionA', 'id':'a', 'selectionA':selectionA});
    //set seleciton to false
    selectionStart=false;
    selectionA.length=0;
  }
  else
  {
    if(pos!=(selectionA.length-1))
    {
      selectionA.push(latestCursorPostion);
    }
  }
  
 
 }
 else
 {
  selectionA.length=0;
  selectionA.push(latestCursorPostion);
 }
 drawSelection([selectionA[0]], this);
  
    //ctx.strokeRect(latestCursorPostion.x*cW, latestCursorPostion.y*cH, cW, cH);
  });

});
//var socket = new io.Socket('gameoflife.duostack.net', {port:9980, 'transports':['websocket', 'flashsocket','xhr-multipart', 'xhr-polling', 'jsonp-polling', 'htmlfile' ]}); 
//var socket = new io.Socket('gameoflife.duostack.net', {port:9980, 'transports':['websocket' ]}); 


</script>

</head>
<body>


</body>
</html>